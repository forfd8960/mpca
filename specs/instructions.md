# Instruction

## Init Repo

This is a `Mine Personal Coding Agent` Project. Its main function is to wrap the Claude Agent SDK, allowing users to easily add new features around a repository. Please convert this Rust project into a workspace containing `crates/mpca-core` (core execution engine), `crates/mpca-pm` (prompt manager), and `apps/mpca-cli` (command line interface). The generated output is a `mpca` CLI. All deps should be placed under the workspace, and each crate should be referenced using `crate-name = { workspace = true }`. The CLI is built using `clap, ratatai`. The prompt manager is built using `minijinja`. The core execution engine is built using `tokio/claude-agent-sdk-rs 0.6`. All deps must be the latest versions.

Please do not write any code yet; simply generate the skeletons for each crate.


## Gen Design Doc

Based on the mpca_arch.png, generate the following design documents:

- Include an ASCII diagram of the core architecture and key processes.

- Each crate has a clear responsibility and public interface.

- mpca-core: The core execution engine. Based on the prompt in different scenarios, it calls the Claude agent SDK to execute tasks. It must provide a very concise and usable interface.

- mpca-pm: The prompt manager, responsible for loading, rendering, and managing prompts. It must provide a very concise and usable interface.

- mpca-cli: The command-line interface, responsible for interacting with the user and calling mpca-core to execute tasks.

- The code structure should be as single-responsibility as possible, avoiding duplicate code. Follow SOLID principles and use the latest Rust features whenever possible.

- Provide a development plan, including tasks for each stage.

- Place the design document in an appropriate location under ./specs.

## Update Design

add config to `.mpca`,
`.mpca/config.toml`:
    - Override default agent behavior (model, permission mode, etc.)
    - Specify additional prompt word template directories
    - Configure Git behavior (auto-commit, branch naming)
    - Configure code review options

every feature should have its own sub-directory under `.mpca/specs/<feature-slug>/` to store all related files:
- `specs/state.toml`: to store the current state of the feature (e.g., current step, progress, cost, etc.)
- `specs/design.md`: to store the design spec for the feature.
- `specs/plan.md`: to store the plan generated by `mpca plan`.
- `specs/verify.md`: to store the verification spec for the feature.
- `docs/impl_details.md`: to store implementation details for the feature.
- `docs/review.md`: to store code review comments for the feature.

Task execution results should be recorded in turns and cost, placed in `state.yml`, and also included in the final PR link.

If interrupted during a `gba run`, it can be resumed on the next run (this should be reflected in the prompts).

Pre-plan the prompts for all scenarios and place them in `crates/gba-pm/templates` for my review.

Update design spec.

## Build MPCA

Create a new Git worktree (branch from main) under `.trees`. Carefully read `@specs/design.md` and, according to its requirements, use a sub-agent to complete its functionality in stages. Commit code after each stage is completed and ensure precommit hooks pass. After completing all stages, start a new sub-agent to use the CodeX code review skill to review the code against the design spec. Then, carefully consider the review results, modify reasonable issues, and commit the code. Finally, ensure all tests pass and all functionality meets the design spec requirements, then generate a pull request with a detailed PR description.

## update model and baseurl
